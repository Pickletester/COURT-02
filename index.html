<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Court 2 — Status Board</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* Global Reset and Base Styles */
    html, body { 
      margin:0; padding:0; width:100vw; height:100vh; overflow:hidden; 
      background:transparent; font-family: 'Inter', Arial, Helvetica, sans-serif; 
    }

    /* Main Status Bar Container */
    .bar{
      position:fixed; left:0; right:0; bottom:0; height:80px; /* Increased height */
      display:grid; 
      /* Columns adjusted for better label visibility */
      grid-template-columns:1.2fr 2fr 1.1fr 2fr 1.2fr;
      gap:6px; padding:10px 15px; box-sizing:border-box;
      transition: background 400ms ease;
      /* Darker, professional gradient */
      background:linear-gradient(90deg,#14203a,#22335d 75%);
      box-shadow: 0 -4px 10px rgba(0,0,0,0.3);
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
    }
    .bar.red{ background:linear-gradient(90deg,#5c0000,#a01010 70%); }

    /* Individual Section Styles */
    .sec{ 
      position:relative; display:flex; flex-direction:column; 
      justify-content:center; align-items:center; overflow:hidden; 
      border-radius:10px; /* Rounded corners for sections */
      padding: 4px 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .sec:not(#cn)::before{ 
      content:""; position:absolute; left:0; right:0; top:0; bottom:0; 
      background:#000; opacity:.78; border-radius:10px; 
    }

    /* Label Styles */
    .label{ 
      font-weight:600; text-transform:uppercase; 
      font-size:10px; letter-spacing:.1em; z-index:1; 
      margin-bottom:2px; color:#d4e5fd; 
    }
    #cur .label{ color:#90ff90;} /* Light green for current */
    #nxt .label{ color:#ffee99;} /* Light yellow for next */

    /* Value Styles (The content) */
    .val{ 
      font-weight:800; z-index:1; text-align:center; 
      line-height:1.1; color:#fff; padding:0 4px; 
    }
    #cur .val, #nxt .val{ 
      font-size:15px; white-space:normal; overflow-wrap:anywhere; 
      word-break:break-word; max-height: 40px; overflow: hidden; /* Prevent massive text blocks */
    }
    #cd .val{ font-size:24px; font-weight:900; }
    #now .val{ font-size:18px; font-weight:700; }

    /* Court Number Specific Styles */
    #cn{ transition: background 400ms ease; background: none; }
    #cn.alert::before{
      content:""; position:absolute; left:3px; right:3px; top:3px; bottom:3px;
      background:linear-gradient(180deg,#6a0000,#c80000);
      opacity:.8; border-radius:14px;
    }
    #cn .val{
      position:relative;
      font-size:52px; font-weight:900; padding:4px 14px; letter-spacing:.02em;
      border:4px solid #fff; border-radius:14px; text-shadow:0 1px 3px rgba(0,0,0,.5);
      transition: border-color 300ms ease;
      background: rgba(0,0,0,0.3);
    }
    
    /* Animation Styles */
    .pulse-blue { animation: pulseBlue 2.8s ease-in-out infinite; }
    .pulse-blue::after{
      content:""; position:absolute; left:-6px; right:-6px; top:-6px; bottom:-6px; border-radius:18px;
      animation: glowBlue 2.8s ease-in-out infinite; pointer-events:none;
    }
    @keyframes pulseBlue {
      0%,100%{ border-color:#ffffff; }
      50%{ border-color:#80cfff; }
    }
    @keyframes glowBlue {
      0%,100%{ box-shadow:0 0 8px rgba(0,180,255,0.4); }
      50%{ box-shadow:0 0 18px rgba(0,180,255,0.7); }
    }

    .pulse-red { animation: pulseRed 2.2s ease-in-out infinite; }
    .pulse-red::after{
      content:""; position:absolute; left:-7px; right:-7px; top:-7px; bottom:-7px; border-radius:18px;
      animation: glowRed 2.2s ease-in-out infinite; pointer-events:none;
    }
    @keyframes pulseRed {
      0%,100%{ border-color:#ffffff; }
      50%{ border-color:#ff7a7a; }
    }
    @keyframes glowRed {
      0%,100%{ box-shadow:0 0 10px rgba(255,50,50,0.5); }
      50%{ box-shadow:0 0 25px rgba(255,50,50,1.0); }
    }
    .nopulse { animation:none; }
    .nopulse::after{ content:none; }
    
    /* Metadata time display */
    .meta{ font-size:10px; color:#c0c0c0; font-weight:400; margin-top: 2px; }
  </style>
</head>
<body>
  <div class="bar" id="bar">
    <!-- Court Number -->
    <div id="cn" class="sec"><div class="val pulse-blue" id="cno">2</div></div>
    <!-- Current Event -->
    <div id="cur" class="sec">
        <div class="label">In Progress</div>
        <div class="val" id="curv">Loading...</div>
    </div>
    <!-- Countdown Timer -->
    <div id="cd" class="sec">
        <div class="label" id="cdlbl">Time Left</div>
        <div class="val" id="cdv">--</div>
    </div>
    <!-- Next Event -->
    <div id="nxt" class="sec">
        <div class="label">Upcoming</div>
        <div class="val" id="nxtv">Loading next...</div>
    </div>
    <!-- Current Time -->
    <div id="now" class="sec">
        <div class="label">Current Time</div>
        <div class="val" id="clock">--:--</div>
    </div>
  </div>

<script>
(function(){
  // ======= CONFIG: Update these for each physical display =======
  var COURT_NO = 2; // *** SET FOR COURT 2 ***
  var ORG_MEMBER_ID = "12674";
  var AUTH_B64 = "Basic T3JnXzEyNjc0OjEyNjc0XzE4NWFmZGE3LTdiNGYtNGIwYS04YmEwLWE3OWVhYzc4ODExZA==";
  var TZ = "America/New_York"; // Timezone for displaying local time

  // ======= UTIL =======
  function pad2(n){ return (n<10?"0":"")+n; }
  function toLocalNY(d){
    try{ return d.toLocaleTimeString('en-US', {hour:'numeric', minute:'2-digit', hour12:true, timeZone: TZ}); }
    catch(e){ return d.getHours()+":"+pad2(d.getMinutes()); }
  }
  function todayStrNY(){
    try{ return new Intl.DateTimeFormat('en-CA',{timeZone:TZ,year:'numeric',month:'2-digit',day:'2-digit'}).format(new Date()); }
    catch(e){ var n=new Date(); return n.getFullYear()+"-"+pad2(n.getMonth()+1)+"-"+pad2(n.getDate()); }
  }
  function parseTimeAny(t){
    if(!t){return null;}
    if(Object.prototype.toString.call(t)==='[object Date]'){ return isNaN(t.getTime())?null:t; }
    if(typeof t==='number'){ return new Date(t>1e12?t:t*1000); }
    if(typeof t==='string'){
      var s=t.trim();
      var m=s.match(/^\/Date\((\d+)\)\/$/i); if(m){ return new Date(parseInt(m[1],10)); }
      var d=new Date(s); if(!isNaN(d.getTime())) return d;
    }
    return null;
  }
  function pickArray(c){
    if(!c){return [];}
    if(c instanceof Array){return c;}
    if(typeof c==='object'){
      if(c.Data && c.Data instanceof Array) return c.Data;
      if(c.data && c.data instanceof Array) return c.data;
      if(c.Items && c.Items instanceof Array) return c.Items;
      if(c.Results && c.Results instanceof Array) return c.Results;
    }
    return [];
  }

  // ======= FILTERING LOGIC =======
  function containsCourtN(rec, n){
    n = Number(n)||1;
    
    try{
      // 1. Compile ALL relevant text fields.
      var txt = "";
      var fields = ["Courts","CourtName","ResourceName","Resources","Description","Notes","Title","EventName","Name"];
      for (var i=0;i<fields.length;i++){
        var k = fields[i];
        if (rec && rec[k]) {
          var fieldText = String(rec[k]);
          if (Array.isArray(rec[k])) txt += " " + rec[k].join(", ");
          else txt += " " + fieldText;
        }
      }
      txt = txt.toLowerCase();

      // **CHECK 1 (FIXED): TRUE Facility-Wide Drop-in (Show everywhere)**
      // Only include truly generic, all-facility events (drop/open play).
      if (txt.includes("drop") || txt.includes("open play")) {
          return true; // MATCH! It's a general event, show it everywhere.
      }

      // **CHECK 2: Exact Court Number Match (Specific reservation to this court)**
      // Use RegExp to ensure we only match the exact number 'n' (e.g., 'court 2') 
      var exactCourtRegex = new RegExp("(court\\s|court\\s#)"+n+"\\b", "i");
      if (exactCourtRegex.test(txt)) {
          return true;
      }

      // **CHECK 3: Range detection**
      var m, rangeRegex=/courts?\s+(\d+)\s*[-–]\s*(\d+)/g;
      while ((m = rangeRegex.exec(txt)) !== null) {
        var a = +m[1], b = +m[2];
        if (n >= Math.min(a,b) && n <= Math.max(a,b)) {
            return true;
        }
      }
      
      return false; // Did not match any specific criteria, so we filter it out.
    } catch(e){ 
      console.error("Error in containsCourtN:", e);
      return false; 
    }
  }

  // **Function to clean the event name for display**
  function normalizeEvent(x){
    var nm = (x.EventName||x.Name||x.Title||"Event");
    var s = parseTimeAny(x.StartDateTime||x.StartTime||x.Start);
    var e = parseTimeAny(x.EndDateTime||x.EndTime||x.End);
    
    if (s && e) {
      // REGEX to remove court numbers/ranges from the displayed name (e.g., "(Courts 1-4)")
      var courtPattern = /\s*\(Courts?[\s\d\-–&\s\d\-]*\)/gi;
      var nameWithoutCourts = nm.replace(courtPattern, '').trim();

      return {
        name: nameWithoutCourts, // Use the cleaned name for display
        start: s,
        end: e,
        raw: x // Keep raw data for filtering
      };
    }
    return null;
  }
  
  // ======= CLOCK and other functions remain the same =======
  function tickClock(){
    var el = document.getElementById('clock');
    el.textContent = toLocalNY(new Date());
    var now = new Date();
    var delay = 1000 - (now.getMilliseconds());
    if(delay < 250) delay = 250;
    setTimeout(tickClock, delay);
  }

  function xhrJSON(url, headers, timeoutMs, cb){
    try{
      var x = new XMLHttpRequest();
      x.open("GET", url, true);
      x.timeout = timeoutMs||8000;
      if(headers){ for(var k in headers){ if(headers.hasOwnProperty(k)){ x.setRequestHeader(k, headers[k]); } } }
      x.onreadystatechange = function(){ if(x.readyState === 4){ if(x.status >= 200 && x.status < 300){ var data=null; try{ data=JSON.parse(x.responseText); }catch(e){ data=null; } cb(null, data); } else { cb(new Error("HTTP "+x.status)); } } };
      x.ontimeout = function(){ cb(new Error("timeout")); };
      x.onerror = function(){ cb(new Error("network")); };
      x.send();
    }catch(e){ cb(e); }
  }

  var cdTimer = null, cdMode = "none", cdTarget = null;
  var nxtStart = null;
  var lastCurName = "";

  function setPulse(mode){
    var el = document.getElementById('cno');
    el.className = "val";
    if(mode === "blue"){ el.className += " pulse-blue"; }
    else if(mode === "red"){ el.className += " pulse-red"; }
    else { el.className += " nopulse"; }
  }
  function setBar(mode){
    var bar = document.getElementById('bar');
    var cn = document.getElementById('cn');
    if(mode === "red"){
      bar.className = "bar red";
      cn.className = "sec alert";
    } else {
      bar.className = "bar";
      cn.className = "sec";
    }
  }

  function startCountdown(targetMs, mode){
    cdTarget = targetMs; cdMode = mode||"none";
    if(cdTimer){ clearTimeout(cdTimer); cdTimer = null; }
    function tick(){
      var out = document.getElementById('cdv');
      var lbl = document.getElementById('cdlbl');
      if(!cdTarget){
        out.textContent = "--"; lbl.textContent = "Time Left";
        setPulse("blue"); setBar("blue");
        cdTimer = setTimeout(tick, 1000); return;
      }
      var nowMs = Date.now(), diff = cdTarget - nowMs;
      if(diff > 0){
        if(cdMode === "cur" && diff <= 60000){ setPulse("red"); setBar("red"); }
        else { setPulse("blue"); setBar("blue"); }
        var totalMin = Math.floor(diff/60000);
        if(diff <= 60000){ out.textContent = Math.floor(diff/1000)%60 + "s"; }
        else if(totalMin >= 60){ out.textContent = Math.floor(totalMin/60)+"h "+(totalMin%60)+"m"; }
        else { out.textContent = totalMin+"m"; }
        lbl.textContent = (cdMode==="cur")?"Time Left":"Time Until";
        cdTimer = setTimeout(tick, 1000);
      } else {
        setPulse("red"); setBar("red");
        out.textContent = "EXPIRED"; lbl.textContent = "Refreshes soon";
        setTimeout(()=>{ setPulse("blue"); setBar("blue"); },30000);
      }
    }
    tick();
  }

  function fmtTime(d){ return "<div class='meta'>"+toLocalNY(d.start)+" - "+toLocalNY(d.end)+"</div>"; }

  function render(cur, nxt){
    var curEl = document.getElementById('curv');
    var nxtEl = document.getElementById('nxtv');
    
    // CURRENT EVENT RENDERING
    if(cur){
      // Store current name for debugging/logging
      lastCurName = cur.name; 
      // Render name and time metadata
      curEl.innerHTML = cur.name + fmtTime(cur);
      // Start countdown to the end of the current event
      startCountdown(cur.end.getTime(), "cur");
    } else {
      // Set to "No current event" when court is free
      curEl.textContent = "No current event"; 
      // If no current event, countdown to the next event
      if(nxt){ startCountdown(nxt.start.getTime(), "next"); }
      // If no current or next event, clear countdown
      else { startCountdown(null, "none"); }
    }
    
    // NEXT EVENT RENDERING
    if(nxt){ 
      nxtEl.innerHTML = nxt.name + fmtTime(nxt); 
    } else { 
      nxtEl.textContent = "No upcoming event"; 
    }
  }

  // ======= DATA FETCHING & RENDERING =======
  var cacheEv = [], cacheRes = [];

  function refresh(){
    var d = todayStrNY();
    // API endpoint for all events today
    var ev = "https://api.courtreserve.com/api/v1/eventcalendar/eventlist?orgMemberId="+ORG_MEMBER_ID+"&startDate="+d+"T00:00:00&endDate="+d+"T23:59:59";
    // API endpoint for all reservations today
    var res = "https://api.courtreserve.com/api/v1/reservationreport/listactive?orgMemberId="+ORG_MEMBER_ID+"&reservationsFromDate="+d+"T00:00:00&reservationsToDate="+d+"T23:59:59&includePlayers=true";

    xhrJSON(ev, {"Authorization":AUTH_B64}, 8000, function(errE, dataE){
      if(!errE){ cacheEv = pickArray(dataE); } else { console.error("Error fetching events:", errE); }
      xhrJSON(res, {"Authorization":AUTH_B64}, 8000, function(errR, dataR){
        if(!errR){ cacheRes = pickArray(dataR); } else { console.error("Error fetching reservations:", errR); }
        computeAndRender();
      });
    });
  }

  function computeAndRender(){
    var ev = cacheEv.map(normalizeEvent).filter(Boolean);
    var rs = cacheRes.map(normalizeResv).filter(Boolean);
    
    // Filter events/reservations by the court number using the updated logic
    var evC = ev.filter(x => containsCourtN(x.raw, COURT_NO));
    var rsC = rs.filter(x => containsCourtN(x.raw, COURT_NO));
    
    // Combine and sort by start time
    var all = rsC.concat(evC).sort((a,b)=>a.start.getTime()-b.start.getTime());
    var now = new Date(), cur=null, nxt=null;

    // Find current and next event
    for(var i=0;i<all.length;i++){
      var it=all[i];
      if(!cur && now>=it.start && now<=it.end) cur=it; // Current is happening now
      if(!nxt && now<it.start) nxt=it; // Next is the first one that starts after now
    }
    render(cur,nxt);
  }
  
  function shortName(p){ 
    var fn=(p.FirstName||"").trim(),ln=(p.LastName||"").trim(); 
    var init=fn?fn[0].toUpperCase()+".":""; 
    return (init&&ln)?init+" "+ln:(init||ln||""); 
  }
  
  function normalizeResv(x){
    var s=parseTimeAny(x.StartTime||x.StartDateTime||x.Start);
    var e=parseTimeAny(x.EndTime||x.EndDateTime||x.End);
    if(!s||!e)return null;
    
    var name="Reserved"; 
    
    // Prefer player names for reservation display
    if(x.Players&&Array.isArray(x.Players)&&x.Players.length){ 
        name=x.Players.map(shortName).filter(n=>n.length>0).join(", "); 
    }
    
    // Fallback to reservation type name
    if(!name||name==="Reserved"){
        if(x.ReservationTypeName){ name = x.ReservationTypeName; }
    }

    return {name:name,start:s,end:e,raw:x};
  }

  // Initial setup and polling
  document.getElementById('cno').textContent = String(COURT_NO);
  tickClock();
  refresh();
  setInterval(refresh, 30000); // Poll every 30 seconds
})();
</script>
</body>
</html>
