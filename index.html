<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Court Display — TB1 SAFE (ES5 + XHR)</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body { margin:0; padding:0; width:100vw; height:100vh; overflow:hidden; background:transparent; font-family: Arial, Helvetica, sans-serif; }
    :root { --bar-height: 72px; --pulse-dur: 900ms; --pulse-min: .12; --pulse-max: .45; --pulse-border: 3px; }
    .graphic-bar{ position:fixed; left:0; right:0; bottom:0; height:var(--bar-height); background:linear-gradient(90deg,#14203a,#22335d 70%); display:grid; grid-template-columns:1.3fr 2.2fr 1.1fr 2.1fr 1.3fr; gap:4px; padding:4px 6px; box-sizing:border-box; z-index:1000; }
    .section{ position:relative; display:flex; flex-direction:column; justify-content:center; align-items:center; overflow:hidden; border-radius:6px; }
    .section .compat-bg{ position:absolute; left:3px; right:3px; top:3px; bottom:3px; background:#000; opacity:.78; border-radius:6px; z-index:0; pointer-events:none; }
    #court-number .compat-bg{ display:none !important; }
    .label{ font-weight:700; text-transform:uppercase; font-size:10px; letter-spacing:.08em; z-index:2; margin-bottom:1px; }
    #current-event .label{ color:#6cff6c;} #next-event .label{ color:#ffe56b;} #countdown .label{ color:#d4e5fd;} #current-time .label{ color:#d4e5fd;}
    .meta{ font-size:10px; color:#d8d8d8; opacity:.9; line-height:1.05; }
    .value{ font-weight:800; z-index:2; text-align:center; line-height:1.05; color:#fff; padding:0 4px; }
    #current-event .value,#next-event .value{ font-size:14px; white-space:normal; overflow-wrap:anywhere; word-break:break-word; padding:0 6px 3px; align-self:center; }
    #countdown .value{ font-size:20px;} #current-time .value{ font-size:16px;}
    #court-number{ display:flex; align-items:center; justify-content:center;}
    #court-number .value{ font-size:58px; font-weight:900; padding:2px 12px; letter-spacing:.02em; border:2px solid #fff; border-radius:8px; text-shadow:0 1px 2px rgba(0,0,0,.4); background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.03)); color:#fff; line-height:1; }
    #countdown.under-minute .cdFill{ position:absolute; left:2px; right:2px; top:2px; bottom:2px; border-radius:6px; pointer-events:none; z-index:1; display:block; background:#ff0000; animation:pulse var(--pulse-dur) ease-in-out infinite; }
    #countdown.under-minute .cdBorder{ position:absolute; left:2px; right:2px; top:2px; bottom:2px; border-radius:6px; pointer-events:none; z-index:1; display:block; border:var(--pulse-border) solid rgba(255,0,0,.2); animation:pulse var(--pulse-dur) ease-in-out infinite; }
    @keyframes pulse{0%{opacity:.12;transform:scale(1)}50%{opacity:.45;transform:scale(1.03)}100%{opacity:.12;transform:scale(1)}}
  </style>
</head>
<body>
  <div class="graphic-bar" id="bar">
    <div id="court-number" class="section"><div class="value" id="court-val">1</div></div>
    <div id="current-event" class="section"><div class="compat-bg"></div><div class="label" id="cur-label">In Progress</div><div class="value" id="cur-val">Loading...</div></div>
    <div id="countdown" class="section"><div class="compat-bg"></div><div class="label" id="cd-label">Time Left</div><div class="value" id="cd-val">--</div><div class="cdFill" style="display:none;"></div><div class="cdBorder" style="display:none;"></div></div>
    <div id="next-event" class="section"><div class="compat-bg"></div><div class="label">Upcoming</div><div class="value" id="next-val">Loading next...</div></div>
    <div id="current-time" class="section"><div class="compat-bg"></div><div class="label">Current Time</div><div class="value" id="clock">--:--</div></div>
  </div>

<script>
// ====== CONFIG (keep these values the same as your working desktop build) ======
var ORG_MEMBER_ID = "12674";
var AUTH_B64 = "Basic T3JnXzEyNjc0OjEyNjc0XzE4NWFmZGE3LTdiNGYtNGIwYS04YmEwLWE3OWVhYzc4ODExZA=="; // Basic base64

// Read court number from ?court=
function getCourtNo() {
  var m = location.search.match(/[?&]court=(\d{1,2})/i);
  var n = m ? parseInt(m[1],10) : 1;
  if (!n || n<1) n=1;
  return n;
}
var COURT_NO = getCourtNo();
document.getElementById('court-val').textContent = String(COURT_NO);

// Helpers
function toNY(ms){
  try {
    return new Date(ms).toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true,timeZone:'America/New_York'});
  } catch(e) { // if TZ not supported
    var d=new Date(ms); var hh=d.getHours(), mm=('0'+d.getMinutes()).slice(-2);
    var ampm=hh>=12?'PM':'AM'; hh = hh%12; if(hh===0) hh=12; return hh+':'+mm+' '+ampm;
  }
}
function todayISO(){
  var d = new Date();
  var tzOff = d.getTimezoneOffset()*60000;
  var ny = new Date(d.getTime()); // local date okay for day bounds used by CR
  var yyyy = ny.getFullYear();
  var mm = ('0'+(ny.getMonth()+1)).slice(-2);
  var dd = ('0'+ny.getDate()).slice(-2);
  return yyyy+'-'+mm+'-'+dd;
}

function parseTimeAny(t, baseDate){
  if (!t) return null;
  if (typeof t === 'number') return new Date(t>1e12?t:t*1000);
  if (t instanceof Date) return isNaN(t.getTime())?null:t;
  if (typeof t === 'string'){
    var s=t.trim();
    var m = s.match(/^\/Date\((\d+)\)\/$/i); if(m) return new Date(parseInt(m[1],10));
    var hm = s.match(/^(\d{1,2}):(\d{2})(?:\s*([AP]M))?$/i);
    if (hm){
      var base = baseDate || new Date();
      var hh=parseInt(hm[1],10), mm=parseInt(hm[2],10);
      var ampm = hm[3]?hm[3].toUpperCase():null;
      if (ampm==='PM' && hh<12) hh+=12;
      if (ampm==='AM' && hh===12) hh=0;
      return new Date(base.getFullYear(),base.getMonth(),base.getDate(),hh,mm,0,0);
    }
    var d = new Date(s); if(!isNaN(d.getTime())) return d;
  }
  return null;
}

function pickArray(c){
  if(!c) return [];
  if(c instanceof Array) return c;
  if(typeof c==='object'){
    var keys=['Data','data','Results','Items','Reservations','ReservationList'];
    for(var i=0;i<keys.length;i++){ var k=keys[i]; if(c[k] instanceof Array) return c[k]; }
    if(c.Data && typeof c.Data==='object'){
      for(var j=0;j<keys.length;j++){ var kk=keys[j]; if(c.Data[kk] instanceof Array) return c.Data[kk]; }
    }
  }
  return [];
}

function collectNumsFromAny(v, out){
  if(v==null) return;
  var t=typeof v;
  if(t==='number' && isFinite(v)){ out[v]=true; return; }
  if(t==='string'){
    var s=v.toLowerCase(), m;
    var re1=/(?:court|courts|crt|ct|resource|rm)\s*#?\s*(\d{1,2})(?:\s*[-–]\s*(\d{1,2}))?/g;
    while((m=re1.exec(s))!==null){ var a=+m[1], b=m[2]?+m[2]:null; if(b!=null){ for(var i=Math.min(a,b); i<=Math.max(a,b); i++) out[i]=true;} else out[a]=true; }
    var re2=/(\d{1,2})\s*[-–]\s*(\d{1,2})/g;
    while((m=re2.exec(s))!==null){ var a2=+m[1], b2=+m[2]; for(var j=Math.min(a2,b2); j<=Math.max(a2,b2); j++) out[j]=true; }
    var re3=/(^|[^\d])(\d{1,2})(?=\s*(?:[,&/+]|and|\b))/g;
    while((m=re3.exec(s))!==null){ out[+m[2]]=true; }
    return;
  }
  if(v instanceof Array){ for(var k=0;k<v.length;k++) collectNumsFromAny(v[k], out); return; }
  if(t==='object'){
    var prefer=['Courts','AssignedCourts','EventCourts','Resources','Court','CourtId','CourtIds','CourtNumber','CourtNumbers','CourtName','CourtNames','CourtNamesCsv','CourtsText','Resource','ResourceId','ResourceIds','ResourceName'];
    for(var p=0;p<prefer.length;p++){ var key=prefer[p]; if(v.hasOwnProperty(key)) collectNumsFromAny(v[key], out); }
    for(var kk in v){ if(/court|resource/i.test(kk)) collectNumsFromAny(v[kk], out); }
    if(Object.keys(out).length===0){ for(var kk2 in v){ var val=v[kk2]; if(typeof val==='string') collectNumsFromAny(val,out); } }
    return;
  }
}
function extractCourtNumbersDeep(rec){
  var out={};
  collectNumsFromAny(rec,out);
  var arr=[], key;
  for(key in out){ if(out.hasOwnProperty(key)) arr.push(+key); }
  return arr;
}
function matchesCourtStrict(rec, n){
  try {
    var nums=extractCourtNumbersDeep(rec);
    for(var i=0;i<nums.length;i++) if(nums[i]===n) return true;
    return false;
  } catch(e){ return false; }
}

// Thin XHR helper (GET JSON with Authorization header)
function getJSON(url, cb){
  try{
    var xhr=new XMLHttpRequest();
    xhr.open('GET', url, true);
    xhr.setRequestHeader('Authorization', AUTH_B64);
    xhr.onreadystatechange=function(){
      if(xhr.readyState===4){
        if(xhr.status>=200 && xhr.status<300){
          try{ cb(null, JSON.parse(xhr.responseText)); }catch(e){ cb(e); }
        } else {
          cb(new Error('HTTP '+xhr.status));
        }
      }
    };
    xhr.onerror=function(){ cb(new Error('network error')); };
    xhr.ontimeout=function(){ cb(new Error('timeout')); };
    xhr.timeout=6000;
    xhr.send();
  }catch(e){ cb(e); }
}

function render(cur, nxt){
  var curEl=document.getElementById('cur-val');
  var cdLabel=document.getElementById('cd-label');
  var nextEl=document.getElementById('next-val');
  if(cur){
    curEl.innerHTML = cur.name + "<div class='meta'>" + toNY(cur.start.getTime()) + " - " + toNY(cur.end.getTime()) + "</div>";
    cdLabel.textContent='Time Left';
    setCountdown(cur.end.getTime(), 'cur', nxt ? nxt.start.getTime() : null);
  } else {
    curEl.textContent='No current event';
    if(nxt){
      cdLabel.textContent='Time Until';
      setCountdown(nxt.start.getTime(), 'next', null);
    } else {
      cdLabel.textContent='Time Left';
      setCountdown(null, 'none', null);
    }
  }
  if(nxt){ nextEl.innerHTML = nxt.name + "<div class='meta'>" + toNY(nxt.start.getTime()) + " - " + toNY(nxt.end.getTime()) + "</div>"; }
  else { nextEl.textContent='No upcoming event'; }
}

var countdownTimer=null, countdownTarget=null, countdownMode='none', nextStartMs=null;
function setUnderMinute(on){
  var box=document.getElementById('countdown');
  var fill = box.querySelector('.cdFill'), border=box.querySelector('.cdBorder');
  if(on){ box.className = box.className.indexOf('under-minute')===-1 ? (box.className+' under-minute') : box.className; fill.style.display='block'; border.style.display='block'; }
  else { box.className = box.className.replace(/\bunder-minute\b/,'').trim(); fill.style.display='none'; border.style.display='none'; }
}
function setCountdown(newTargetMs, newMode, nextStart){
  countdownTarget=newTargetMs; countdownMode=newMode; nextStartMs=nextStart;
  if(countdownTimer) { clearInterval(countdownTimer); countdownTimer=null; }
  if(!newTargetMs){ document.getElementById('cd-val').textContent='--'; setUnderMinute(false); return; }
  countdownTimer=setInterval(tickCountdown, 500);
}
function tickCountdown(){
  var el=document.getElementById('cd-val');
  var now = Date.now();
  var diff = countdownTarget - now;
  if(diff>0){
    var totalSec=Math.floor(diff/1000); var totalMin=Math.floor(diff/60000);
    if(diff<=60000){ var s=totalSec%60; el.textContent=s+'s'; setUnderMinute(true); }
    else { if(totalMin>=60){ var h=Math.floor(totalMin/60), rem=totalMin%60; el.textContent=h+'h '+rem+'m'; } else { el.textContent=totalMin+'m'; } setUnderMinute(false); }
  }else{
    setUnderMinute(false);
    if(countdownMode==='cur' && nextStartMs){ countdownMode='next'; countdownTarget=nextStartMs; document.getElementById('cd-label').textContent='Time Until'; }
    else { el.textContent='--'; countdownTarget=null; clearInterval(countdownTimer); countdownTimer=null; }
  }
}

function refresh(){
  var d = todayISO();
  var evUrl = "https://api.courtreserve.com/api/v1/eventcalendar/eventlist?orgMemberId="+encodeURIComponent(ORG_MEMBER_ID)+"&startDate="+d+"T00:00:00&endDate="+d+"T23:59:59";
  var resUrl= "https://api.courtreserve.com/api/v1/reservationreport/listactive?reservationsFromDate="+d+"&reservationsToDate="+d;

  var gotE=null, gotR=null, errE=null, errR=null;
  function maybeProcess(){
    if(gotE===null || gotR===null) return;
    var eArr = gotE && !errE ? pickArray(gotE) : [];
    var rArr = gotR && !errR ? pickArray(gotR) : [];
    // Map
    var baseDateLocal = new Date();
    var events=[], reservations=[];
    for(var i=0;i<eArr.length;i++){
      var x=eArr[i];
      var start=parseTimeAny(x.StartDateTime||x.StartTime||x.Start, baseDateLocal);
      var end  =parseTimeAny(x.EndDateTime||x.EndTime||x.End,   baseDateLocal);
      if(start && end && matchesCourtStrict(x, COURT_NO)){
        events.push({source:'event', raw:x, name:(x.EventName||x.Name||'Event'), start:start, end:end});
      }
    }
    for(var j=0;j<rArr.length;j++){
      var y=rArr[j];
      var start2=parseTimeAny(y.StartTime||y.StartDateTime||y.Start, baseDateLocal);
      var end2  =parseTimeAny(y.EndTime||y.EndDateTime||y.End,   baseDateLocal);
      if(!(start2 && end2 && matchesCourtStrict(y, COURT_NO))) continue;
      var players = y.Players instanceof Array ? y.Players : [];
      var pn=[];
      for(var k=0;k<players.length;k++){
        var p=players[k]; var fn=(p.FirstName||'').trim(), ln=(p.LastName||'').trim();
        var nm = fn && ln ? (fn+' '+(ln[0]||'')+'.') : (fn+' '+ln).trim();
        if(nm) pn.push(nm);
      }
      var nm2 = pn.length ? pn.join(', ') : (function(){
        var fields=['MemberDisplayName','OrganizerName','Organizer','MemberName','MemberFullName','OwnerName','BookedByName','BookerName','CreatedByName','ReservationOwnerName','PrimaryMemberName','CreatedBy','DisplayName','ReservationName','Title','Description','Notes','PlayersText','CreatedByDisplayName'];
        for(var q=0;q<fields.length;q++){ var k2=fields[q]; if(y[k2] && String(y[k2]).trim()) return String(y[k2]).trim(); }
        if(y.ReservationTypeName && y.ReservationTypeName.trim()) return y.ReservationTypeName.trim();
        return 'Reserved';
      })();
      reservations.push({source:'reservation', raw:y, name:nm2, start:start2, end:end2});
    }
    var forCourt = reservations.concat(events).sort(function(a,b){ return a.start - b.start; });
    var now = Date.now();
    var cur=null, nxt=null;
    for(var t=0;t<forCourt.length;t++){
      var it=forCourt[t];
      if(!cur && now>=it.start.getTime() && now<=it.end.getTime()) cur=it;
      if(!nxt && now<it.start.getTime()) nxt=it;
    }
    render(cur, nxt);
  }

  // throttle: at most 2 CR requests / minute (enforced by interval below)
  getJSON(evUrl, function(err, json){ errE=err||null; gotE = err?{}:json; maybeProcess(); });
  getJSON(resUrl, function(err, json){ errR=err||null; gotR = err?{}:json; maybeProcess(); });
}

function tickClock(){
  var el=document.getElementById('clock');
  try { el.textContent=new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true,timeZone:'America/New_York'}); }
  catch(e){ var d=new Date(); var hh=d.getHours(), mm=('0'+d.getMinutes()).slice(-2); var ampm=hh>=12?'PM':'AM'; hh = hh%12; if(hh===0) hh=12; el.textContent=hh+':'+mm+' '+ampm; }
  setTimeout(tickClock, 1000);
}

// init
function init(){
  refresh();
  setInterval(refresh, 60*1000); // once per minute
  tickClock();
}
if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', init); } else { init(); }

</script>
</body>
</html>
